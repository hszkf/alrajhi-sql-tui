#!/bin/bash
# atui - Alrajhi SQL TUI
# Install: curl -fsSL https://raw.githubusercontent.com/hszkf/alrajhi-sql-tui/master/atui | sudo tee /usr/local/bin/atui > /dev/null && sudo chmod +x /usr/local/bin/atui

set -e
INSTALL_DIR="$HOME/alrajhi-sql-tui"
REPO="https://github.com/hszkf/alrajhi-sql-tui.git"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_banner() {
    echo -e "${BLUE}"
    echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "  â•‘  ðŸ¦ ALRAJHI SQL STUDIO            â•‘"
    echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

install_rust() {
    if ! command -v cargo &> /dev/null; then
        echo -e "${YELLOW}Installing Rust...${NC}"
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        source "$HOME/.cargo/env"
    fi
}

clone_repo() {
    echo -e "${BLUE}Cloning repository...${NC}"
    git clone "$REPO" "$INSTALL_DIR"
}

build_app() {
    echo -e "${BLUE}Building (this may take 1-2 minutes)...${NC}"
    cd "$INSTALL_DIR"
    cargo build --release 2>/dev/null
    echo -e "${GREEN}âœ“ Build complete${NC}"
}

configure() {
    echo ""
    echo -e "${YELLOW}Configure Database Connection:${NC}"
    read -p "  Host [10.200.224.42]: " DB_HOST
    read -p "  Port [1433]: " DB_PORT
    read -p "  User [ssis_admin]: " DB_USER
    read -sp "  Password: " DB_PASSWORD
    echo ""
    read -p "  Database [Staging]: " DB_DATABASE

    cat > "$INSTALL_DIR/.env" << EOF
DB_HOST=${DB_HOST:-10.200.224.42}
DB_PORT=${DB_PORT:-1433}
DB_USER=${DB_USER:-ssis_admin}
DB_PASSWORD=${DB_PASSWORD}
DB_DATABASE=${DB_DATABASE:-Staging}
EOF
    echo -e "${GREEN}âœ“ Configuration saved${NC}"
}

run_app() {
    cd "$INSTALL_DIR"
    source .env 2>/dev/null || true
    exec ./target/release/alrajhi_sql_tui
}

do_install() {
    print_banner
    echo -e "${BLUE}First time setup...${NC}"
    install_rust
    clone_repo
    build_app
    configure
    echo ""
    echo -e "${GREEN}âœ“ Installation complete!${NC}"
    echo ""
    run_app
}

do_update() {
    print_banner
    echo -e "${BLUE}Updating...${NC}"
    cd "$INSTALL_DIR"
    git pull
    build_app
    echo -e "${GREEN}âœ“ Update complete!${NC}"
    echo ""
    run_app
}

do_config() {
    print_banner
    configure
    run_app
}

show_help() {
    print_banner
    echo "Usage: atui [command]"
    echo ""
    echo "Commands:"
    echo "  (none)     Run SQL Studio (install if needed)"
    echo "  update     Update to latest version"
    echo "  config     Reconfigure database connection"
    echo "  help       Show this help"
    echo ""
}

# Main
case "${1:-}" in
    update)
        do_update
        ;;
    config)
        do_config
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        if [ -d "$INSTALL_DIR" ] && [ -f "$INSTALL_DIR/target/release/alrajhi_sql_tui" ]; then
            # Already installed - just run
            if [ ! -f "$INSTALL_DIR/.env" ]; then
                print_banner
                configure
            fi
            run_app
        else
            # First time - install
            do_install
        fi
        ;;
esac
