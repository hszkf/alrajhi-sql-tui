#!/bin/bash
# atui - Alrajhi SQL TUI
# Install: curl -fsSL https://raw.githubusercontent.com/hszkf/alrajhi-sql-tui/master/atui | sudo tee /usr/local/bin/atui > /dev/null && sudo chmod +x /usr/local/bin/atui

set -e
# Use script's directory if available, otherwise default to ~/alrajhi-sql-tui
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
if [ -f "$SCRIPT_DIR/Cargo.toml" ]; then
    INSTALL_DIR="$SCRIPT_DIR"
else
    INSTALL_DIR="$HOME/alrajhi-sql-tui"
fi
REPO="https://github.com/hszkf/alrajhi-sql-tui.git"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

print_banner() {
    echo -e "${BLUE}"
    echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "  â•‘  ðŸ¦ ALRAJHI SQL STUDIO            â•‘"
    echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
}

install_rust() {
    if ! command -v cargo &> /dev/null; then
        echo -e "${YELLOW}Rust not found. Installing...${NC}"

        # Try curl first, then wget
        if command -v curl &> /dev/null; then
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
        elif command -v wget &> /dev/null; then
            wget -qO- https://sh.rustup.rs | sh -s -- -y
        else
            echo -e "${RED}âŒ Neither curl nor wget found.${NC}"
            echo "   Please install Rust manually: https://rustup.rs"
            exit 1
        fi

        source "$HOME/.cargo/env"
        echo -e "${GREEN}âœ“ Rust installed${NC}"
    else
        echo -e "${GREEN}âœ“ Rust found${NC}"
    fi
}

clone_repo() {
    echo -e "${BLUE}Cloning repository...${NC}"
    git clone "$REPO" "$INSTALL_DIR"
}

build_app() {
    echo -e "${BLUE}Building (this may take 1-2 minutes)...${NC}"
    cd "$INSTALL_DIR"
    cargo build --release 2>/dev/null
    echo -e "${GREEN}âœ“ Build complete${NC}"
}

configure() {
    echo ""
    echo -e "${YELLOW}Configure Database Connection:${NC}"
    read -p "  Host [10.200.224.42]: " DB_HOST
    read -p "  Port [1433]: " DB_PORT
    read -p "  User [ssis_admin]: " DB_USER
    read -sp "  Password: " DB_PASSWORD
    echo ""
    read -p "  Database [Staging]: " DB_DATABASE

    cat > "$INSTALL_DIR/.env" << EOF
DB_HOST=${DB_HOST:-10.200.224.42}
DB_PORT=${DB_PORT:-1433}
DB_USER=${DB_USER:-ssis_admin}
DB_PASSWORD=${DB_PASSWORD}
DB_DATABASE=${DB_DATABASE:-Staging}
EOF
    echo -e "${GREEN}âœ“ Configuration saved${NC}"
}

run_app() {
    cd "$INSTALL_DIR"
    set -a
    source .env 2>/dev/null || true
    set +a
    exec ./target/release/alrajhi_sql_tui
}

do_install() {
    print_banner
    echo -e "${BLUE}First time setup...${NC}"
    install_rust
    clone_repo
    build_app
    configure
    echo ""
    echo -e "${GREEN}âœ“ Installation complete!${NC}"
    echo ""
    run_app
}

do_update() {
    print_banner
    echo -e "${BLUE}Updating...${NC}"
    cd "$INSTALL_DIR"
    git pull
    build_app
    echo -e "${GREEN}âœ“ Update complete!${NC}"
    echo ""
    run_app
}

do_config() {
    print_banner
    configure
    run_app
}

do_test() {
    print_banner
    echo -e "${BLUE}Testing connection...${NC}"
    echo ""

    # Load config
    if [ -f "$INSTALL_DIR/.env" ]; then
        set -a
        source "$INSTALL_DIR/.env"
        set +a
    else
        echo -e "${RED}âŒ No .env file found. Run: atui config${NC}"
        exit 1
    fi

    HOST="${DB_HOST:-10.200.224.42}"
    PORT="${DB_PORT:-1433}"

    echo -e "  Host: ${YELLOW}$HOST${NC}"
    echo -e "  Port: ${YELLOW}$PORT${NC}"
    echo ""

    # Test 1: Ping
    echo -n "  [1/3] Ping host... "
    if ping -c 1 -W 3 "$HOST" &> /dev/null; then
        echo -e "${GREEN}âœ“ OK${NC}"
    else
        echo -e "${RED}âœ— FAILED${NC}"
        echo -e "${RED}      Host not reachable. Check network/VPN.${NC}"
        exit 1
    fi

    # Test 2: Port
    echo -n "  [2/3] Port $PORT... "
    if nc -zw3 "$HOST" "$PORT" &> /dev/null; then
        echo -e "${GREEN}âœ“ OK${NC}"
    else
        echo -e "${RED}âœ— FAILED${NC}"
        echo -e "${RED}      Port blocked. Your IP may need to be whitelisted.${NC}"
        echo ""
        echo -e "      Your IP: ${YELLOW}$(curl -s ifconfig.me 2>/dev/null || hostname -I | awk '{print $1}')${NC}"
        echo -e "      Ask DBA to allow your IP on SQL Server firewall."
        exit 1
    fi

    # Test 3: SQL Connection
    echo -n "  [3/3] SQL login... "
    cd "$INSTALL_DIR"
    if [ -f "target/release/test_date_query" ]; then
        set -a
        source .env
        set +a
        if ./target/release/test_date_query 2>&1 | grep -q "Connected successfully"; then
            echo -e "${GREEN}âœ“ OK${NC}"
            echo ""
            echo -e "${GREEN}âœ“ All tests passed! Connection is working.${NC}"
        else
            echo -e "${RED}âœ— FAILED${NC}"
            echo -e "${RED}      Check username/password in .env${NC}"
            exit 1
        fi
    else
        echo -e "${YELLOW}? SKIP (test binary not found)${NC}"
        echo ""
        echo -e "${GREEN}âœ“ Network tests passed!${NC}"
    fi
}

show_help() {
    print_banner
    echo "Usage: atui [command]"
    echo ""
    echo "Commands:"
    echo "  (none)     Run SQL Studio (install if needed)"
    echo "  update     Update to latest version"
    echo "  config     Reconfigure database connection"
    echo "  test       Test database connection"
    echo "  help       Show this help"
    echo ""
}

# Main
case "${1:-}" in
    update)
        do_update
        ;;
    config)
        do_config
        ;;
    test)
        do_test
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        if [ -d "$INSTALL_DIR" ] && [ -f "$INSTALL_DIR/target/release/alrajhi_sql_tui" ]; then
            # Already installed - just run
            if [ ! -f "$INSTALL_DIR/.env" ]; then
                print_banner
                configure
            fi
            run_app
        else
            # First time - install
            do_install
        fi
        ;;
esac
